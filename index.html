import telebot
import time
import random
import sqlite3
from telebot import types

import asyncio
from aiohttp import web

API_TOKEN = "7753611465:AAHGF6-DlfuX-vFi28MYjxbq-PVJoJeHKJ0"
bot = telebot.TeleBot(API_TOKEN)

ADMIN_ID = 5767213888
DB_PATH = "bot_data.db"

required_channels = {
    "@redhat_REDHAT10": "Join Channel 1 ğŸ“±",
    "@mines_signalsREDHAT69": "Join Channel 2 ğŸ“±"
}

IMAGES = [
    "https://i.imgur.com/7uuILcO.jpeg",
    "https://i.imgur.com/iwDyPNq.jpeg",
    "https://i.imgur.com/ogjTLdZ.jpeg",
]

last_message_per_user = {}

# --- Database ---
def init_db():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("""
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    """)
    conn.commit()
    conn.close()

def add_user(user_id):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("INSERT OR IGNORE INTO users (user_id) VALUES (?)", (user_id,))
    conn.commit()
    conn.close()

def get_all_users():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("SELECT user_id FROM users")
    users = [row[0] for row in c.fetchall()]
    conn.close()
    return users

def edit_or_send_message(chat_id, text, reply_markup=None, parse_mode=None):
    last_msg_id = last_message_per_user.get(chat_id)
    try:
        if last_msg_id:
            bot.edit_message_text(text, chat_id=chat_id, message_id=last_msg_id,
                                  reply_markup=reply_markup, parse_mode=parse_mode)
            return last_msg_id
    except:
        pass
    msg = bot.send_message(chat_id, text, reply_markup=reply_markup, parse_mode=parse_mode)
    last_message_per_user[chat_id] = msg.message_id
    return msg.message_id

def has_joined_required_channels(user_id):
    status_dict = {}
    for channel in required_channels:
        try:
            member_status = bot.get_chat_member(channel, user_id)
            status_dict[channel] = 'âœ…' if member_status.status not in ['left', 'kicked'] else 'âŒ'
        except:
            status_dict[channel] = 'âŒ'
    return status_dict

# --- Handlers ---
@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.from_user.id
    add_user(user_id)
    channel_status = has_joined_required_channels(user_id)
    if all(v == 'âœ…' for v in channel_status.values()):
        welcome_user(message)
    else:
        ask_to_join_channels(message, channel_status)

def ask_to_join_channels(message, status):
    markup = types.InlineKeyboardMarkup()
    for channel, stat in status.items():
        markup.add(types.InlineKeyboardButton(f"{stat} {required_channels[channel]}", url=f"https://t.me/{channel[1:]}"))
    markup.add(types.InlineKeyboardButton("âœ… I've Joined", callback_data="check_channels"))
    edit_or_send_message(message.chat.id, "*You must join all channels first!*", markup, parse_mode='Markdown')

@bot.callback_query_handler(func=lambda call: call.data == "check_channels")
def check_channels(call):
    user_id = call.from_user.id
    status = has_joined_required_channels(user_id)
    if all(s == 'âœ…' for s in status.values()):
        welcome_user(call.message)
    else:
        bot.answer_callback_query(call.id, "âŒ You still haven't joined all channels!")

def welcome_user(message):
    markup = types.InlineKeyboardMarkup(row_width=2)
    markup.add(
        types.InlineKeyboardButton("1xbet", callback_data="platform_1xbet"),
        types.InlineKeyboardButton("melbet", callback_data="platform_melbet")
    )
    edit_or_send_message(message.chat.id, "ğŸ® *Select your platform first:*", markup, "Markdown")

@bot.callback_query_handler(func=lambda call: call.data.startswith("platform_"))
def handle_platform_selection(call):
    platform = call.data.split("_")[1]
    chat_id = call.message.chat.id
    promo_text = "ğŸ‰ 1xbet promo code: REDHAT10" if platform == "1xbet" else "ğŸ‰ melbet promo code: REDHAT10"
    msg_id = edit_or_send_message(chat_id, promo_text)
    time.sleep(5)
    warning = (
        "âš ï¸ <b>Important: For 100% working, you must create a new account using our promo code:</b>\n\n"
        "ğŸ”¸ <a href='https://1xbet.com'>1xBet Promo Code: REDHAT10</a>\n"
        "ğŸ”¸ <a href='https://melbet.com'>Melbet Promo Code: REDHAT10</a>\n\n"
        "Without the Promo code, the hack may not work correctly.âœ…"
    )
    try:
        bot.edit_message_text(warning, chat_id, msg_id, parse_mode="HTML", disable_web_page_preview=True)
    except:
        pass
    send_game_menu(call.message)

def send_game_menu(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("ğŸŒ€ Next Ball Position", "ğŸ›‘ Stop Hack", "ğŸ² New Game", "ğŸ”„ Restart")
    bot.send_message(message.chat.id, "*ğŸ® Game Menu â€” Choose an option:*", parse_mode='Markdown', reply_markup=markup)

@bot.message_handler(func=lambda m: m.text == "ğŸŒ€ Next Ball Position")
def next_ball_position(message):
    show_next_ball_position(message.chat.id)

@bot.callback_query_handler(func=lambda call: call.data == "next_ball_position")
def callback_next_ball_position(call):
    chat_id = call.message.chat.id
    message_id = call.message.message_id
    bot.edit_message_media(
        types.InputMediaPhoto("https://www.blog.motionisland.com/wp-content/uploads/2022/03/Loading_1.gif", caption="â³ Fetching..."),
        chat_id=chat_id,
        message_id=message_id,
        reply_markup=types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("â³ Loading...", callback_data="noop"))
    )
    time.sleep(2)
    show_next_ball_position(chat_id, message_id)
    bot.answer_callback_query(call.id)

def show_next_ball_position(chat_id, message_id=None):
    image = random.choice(IMAGES)
    markup = types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("â–¶ï¸ Next Ball Position", callback_data="next_ball_position"))
    if message_id:
        bot.edit_message_media(types.InputMediaPhoto(image, caption="âœ… Next position ready!"), chat_id, message_id, reply_markup=markup)
    else:
        bot.send_photo(chat_id, image, caption="âœ… Next position ready!", reply_markup=markup)

@bot.message_handler(func=lambda m: m.text == "ğŸ›‘ Stop Hack")
def stop_hack(message):
    bot.send_message(message.chat.id, "âœ… Hack stopped successfully!", parse_mode='Markdown')

@bot.message_handler(func=lambda m: m.text == "ğŸ² New Game")
def new_game(message):
    bot.send_message(message.chat.id, "âœ… New game ready!", parse_mode='Markdown')

@bot.message_handler(func=lambda m: m.text == "ğŸ”„ Restart")
def restart_bot(message):
    start(message)

@bot.message_handler(commands=['admin'])
def admin_panel(message):
    if message.from_user.id == ADMIN_ID:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        markup.add("ğŸ“¨ Send Broadcast")
        bot.send_message(message.chat.id, "Welcome to the admin panel:", reply_markup=markup)

@bot.message_handler(func=lambda m: m.text == "ğŸ“¨ Send Broadcast" and m.from_user.id == ADMIN_ID)
def request_broadcast(message):
    bot.send_message(message.chat.id, "ğŸ“© Send the broadcast content:")
    bot.register_next_step_handler(message, broadcast_to_all)

def broadcast_to_all(message):
    users = get_all_users()
    count = 0
    for uid in users:
        try:
            if message.content_type == "text":
                bot.send_message(uid, message.text)
            elif message.content_type == "photo":
                bot.send_photo(uid, message.photo[-1].file_id, caption=message.caption or "")
            elif message.content_type == "video":
                bot.send_video(uid, message.video.file_id, caption=message.caption or "")
            elif message.content_type == "sticker":
                bot.send_sticker(uid, message.sticker.file_id)
            elif message.content_type == "document":
                bot.send_document(uid, message.document.file_id, caption=message.caption or "")
            count += 1
            time.sleep(0.3)
        except:
            continue
    bot.send_message(message.chat.id, f"âœ… Broadcast sent to {count} users.")

@bot.message_handler(commands=['user'])
def user_count(message):
    if message.from_user.id == ADMIN_ID:
        bot.send_message(message.chat.id, f"ğŸ‘¥ Total users: {len(get_all_users())}")

# --- Start everything ---
async def main():
    init_db()

    # Start web server (index.html must be in same directory)
    async def handle_index(request):
        return web.FileResponse("index.html")

    app = web.Application()
    app.router.add_get("/", handle_index)

    runner = web.AppRunner(app)
    await runner.setup()
    site = web.TCPSite(runner, "0.0.0.0", 8000)
    await site.start()
    print("âœ… Web server running at http://0.0.0.0:8000")

    # Start bot
    bot.infinity_polling()

if __name__ == "__main__":
    asyncio.run(main())
